<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交互式区块链原理演示</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* --- 全局样式 (与之前文件保持一致) --- */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #121212;
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- 主容器 --- */
        .container {
            width: 100%;
            max-width: 1200px;
            text-align: center;
            padding: 40px 0;
        }

        /* --- 标题和副标题 --- */
        h1 {
            font-size: 2.8em;
            font-weight: 600;
            color: #FFFFFF;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            color: #A0A0A0;
            margin-bottom: 50px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* --- 区块链容器 --- */
        #blockchain-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* --- 区块卡片样式 --- */
        .block-card {
            background-color: #282828;
            border: 2px solid #404040;
            border-radius: 12px;
            padding: 25px;
            width: 100%;
            max-width: 700px;
            text-align: left;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .block-card.valid {
            border-color: #28a745; /* 绿色代表有效 */
        }
        .block-card.invalid {
            border-color: #dc3545; /* 红色代表无效 */
        }

        .block-card h4 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #FFFFFF;
            font-size: 1.4em;
            border-bottom: 1px solid #404040;
            padding-bottom: 15px;
        }

        .field-group {
            margin-bottom: 15px;
        }

        .field-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #B0B0B0;
            font-size: 0.9em;
        }
        
        .field-group .value, .field-group textarea {
            width: 100%;
            padding: 10px;
            background-color: #1E1E1E;
            border: 1px solid #404040;
            border-radius: 6px;
            color: #E0E0E0;
            font-size: 1em;
            font-family: 'Courier New', Courier, monospace;
            box-sizing: border-box;
            word-wrap: break-word;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .field-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .hash-value {
             color: #00bcd4; /* 哈希值用青色高亮 */
        }
        
        /* --- 按钮样式 --- */
        .action-button {
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            color: #FFFFFF;
            background-color: #007BFF;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }
        .action-button:hover {
            background-color: #0056b3;
        }
        .action-button:disabled {
             background-color: #555;
             cursor: not-allowed;
        }

        .add-block-btn {
            margin-top: 20px;
            background-color: #28a745;
        }
        .add-block-btn:hover {
            background-color: #218838;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>交互式区块链原理演示</h1>
        <p class="subtitle">通过亲手操作一个模拟区块链，理解哈希、工作量证明(挖矿)和链式结构如何保证数据的不可篡改性。</p>

        <div id="blockchain-container">
            </div>

        <button id="addBlockBtn" class="action-button add-block-btn">添加新区块</button>
    </div>

<script>
class Block {
    constructor(index, previousHash, timestamp, data, nonce = 0) {
        this.index = index;
        this.previousHash = previousHash.toString();
        this.timestamp = timestamp;
        this.data = data;
        this.nonce = nonce;
        this.hash = this.calculateHash();
    }

    calculateHash() {
        return CryptoJS.SHA256(
            this.index +
            this.previousHash +
            this.timestamp +
            JSON.stringify(this.data) +
            this.nonce
        ).toString();
    }

    mineBlock(difficulty) {
        const leadingZeros = '0'.repeat(difficulty);
        while (this.hash.substring(0, difficulty) !== leadingZeros) {
            this.nonce++;
            this.hash = this.calculateHash();
        }
    }
}

class Blockchain {
    constructor(difficulty = 4) {
        this.chain = [this.createGenesisBlock()];
        this.difficulty = difficulty;
    }

    createGenesisBlock() {
        const genesisBlock = new Block(0, "0", Date.now(), "创世区块 (Genesis Block)");
        genesisBlock.mineBlock(this.difficulty);
        return genesisBlock;
    }

    getLatestBlock() {
        return this.chain[this.chain.length - 1];
    }

    addBlock(newBlock) {
        newBlock.previousHash = this.getLatestBlock().hash;
        newBlock.mineBlock(this.difficulty);
        this.chain.push(newBlock);
    }
    
    isChainValid() {
        for (let i = 1; i < this.chain.length; i++) {
            const currentBlock = this.chain[i];
            const previousBlock = this.chain[i - 1];

            if (currentBlock.hash !== currentBlock.calculateHash()) {
                return false;
            }
            if (currentBlock.previousHash !== previousBlock.hash) {
                return false;
            }
        }
        return true;
    }
}

// --- DOM操作与事件处理 ---
const blockchain = new Blockchain();
const container = document.getElementById('blockchain-container');
const addBlockBtn = document.getElementById('addBlockBtn');

function renderChain() {
    container.innerHTML = ''; // 清空容器
    const leadingZeros = '0'.repeat(blockchain.difficulty);
    let isChainValidAfterThisBlock = true;

    blockchain.chain.forEach((block, index) => {
        const blockDiv = document.createElement('div');
        
        const currentBlockValid = block.hash.substring(0, blockchain.difficulty) === leadingZeros && block.hash === block.calculateHash();
        const linkValid = index === 0 || block.previousHash === blockchain.chain[index - 1].hash;
        const isValid = currentBlockValid && linkValid && isChainValidAfterThisBlock;
        
        blockDiv.className = `block-card ${isValid ? 'valid' : 'invalid'}`;
        
        if (!isValid) {
            isChainValidAfterThisBlock = false;
        }

        blockDiv.innerHTML = `
            <h4>区块 #${block.index}</h4>
            <div class="field-group">
                <label>Nonce (随机数)</label>
                <div class="value">${block.nonce}</div>
            </div>
            <div class="field-group">
                <label>数据 (Data)</label>
                <textarea id="data-${index}">${block.data}</textarea>
            </div>
            <div class="field-group">
                <label>前一个哈希 (Previous Hash)</label>
                <div class="value hash-value">${block.previousHash}</div>
            </div>
            <div class="field-group">
                <label>哈希 (Hash)</label>
                <div class="value hash-value">${block.hash}</div>
            </div>
            <button class="action-button" onclick="handleMine(${index})">挖矿 (Mine)</button>
        `;
        container.appendChild(blockDiv);
    });

    // 为所有textarea添加事件监听
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', (e) => {
            const index = parseInt(e.target.id.split('-')[1]);
            blockchain.chain[index].data = e.target.value;
            blockchain.chain[index].hash = blockchain.chain[index].calculateHash();
            // 从当前块开始更新后续块的previousHash
            for (let i = index + 1; i < blockchain.chain.length; i++) {
                blockchain.chain[i].previousHash = blockchain.chain[i-1].hash;
                blockchain.chain[i].hash = blockchain.chain[i].calculateHash();
            }
            renderChain();
        });
    });
}

function handleMine(index) {
    console.log(`Mining block ${index}...`);
    const block = blockchain.chain[index];
    block.mineBlock(blockchain.difficulty);
    
    // 如果不是最后一个块，则需要更新后面所有块的 `previousHash`
    for (let i = index + 1; i < blockchain.chain.length; i++) {
        blockchain.chain[i].previousHash = blockchain.chain[i-1].hash;
        // 注意：这里我们不自动重新挖矿，只是标记它们为无效，让用户手动修复
        blockchain.chain[i].hash = blockchain.chain[i].calculateHash();
    }

    renderChain();
}

addBlockBtn.addEventListener('click', () => {
    const newBlock = new Block(
        blockchain.getLatestBlock().index + 1,
        blockchain.getLatestBlock().hash,
        Date.now(),
        `这是区块 #${blockchain.chain.length}`
    );
    newBlock.mineBlock(blockchain.difficulty);
    blockchain.chain.push(newBlock);
    renderChain();
});

// 初始化
document.addEventListener('DOMContentLoaded', renderChain);

</script>

</body>
</html>
