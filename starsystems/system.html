<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Star & Planet System Generator</title>
    <style>
        :root {
            --bg-color: #1a1e23;
            --panel-bg: #2a2f36;
            --text-color: #e0e6ec;
            --header-color: #ffffff;
            --border-color: #404853;
            --accent-color: #00aaff;
            --accent-hover: #0088cc;
            --green-color: #28a745;
            --red-color: #dc3545;
            --orange-color: #fd7e14;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
        }
        .generator-panel {
            background-color: var(--panel-bg);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
            flex: 1;
            min-width: 400px;
            display: flex;
            flex-direction: column;
        }
        h1, h2 {
            color: var(--header-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        .lang-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .lang-switcher button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .lang-switcher button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s;
            flex-grow: 1;
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        .btn-secondary {
            background-color: var(--green-color);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #1e7e34;
        }
         .btn-danger {
            background-color: var(--orange-color);
            color: white;
        }
        .btn-danger:hover {
            background-color: #d8680c;
        }
        .output-area {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            flex-grow: 1;
            overflow-y: auto;
            min-height: 200px;
        }
        .description-area {
            background-color: transparent;
            border: none;
            padding: 0 15px 15px 15px;
            font-style: italic;
            color: #a0a8b1;
        }
        .planet-preview {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        #orbitCanvas {
            background-color: #000;
            border-radius: 5px;
            width: 100%;
            aspect-ratio: 16 / 9;
            cursor: grab;
        }
        #orbitCanvas:active {
            cursor: grabbing;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: #3c424a;
            color: var(--text-color);
            box-sizing: border-box;
        }
        #savedPlanetsContainer .planet-entry {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-top: 15px;
            padding: 10px;
        }
        #savedPlanetsContainer h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--accent-color);
        }
        #savedPlanetsContainer .planet-code {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            background: #111315;
            padding: 8px;
            border-radius: 4px;
        }
        #savedPlanetsContainer .planet-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
         #savedPlanetsContainer .planet-actions button {
            font-size: 12px;
            padding: 5px 10px;
        }
    </style>
    <!-- Define where to find the 'three' module -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>

    <div class="lang-switcher">
        <button id="lang-en" class="active">EN</button>
        <button id="lang-zh">ä¸­</button>
    </div>

    <div class="main-container">
        <div class="generator-panel">
            <h1 data-lang-key="starGeneratorTitle">Star Generator</h1>
            <div class="button-group">
                <button id="generateStarBtn" class="btn-primary" data-lang-key="generateStarBtn">Generate New Star</button>
                <button id="copyStarBtn" class="btn-secondary" data-lang-key="copyStarBtn">Copy Star Code</button>
            </div>
            <div id="starDescription" class="description-area"></div>
            <div id="starOutput" class="output-area"></div>
        </div>

        <div class="generator-panel">
            <h1 data-lang-key="planetGeneratorTitle">Planet Generator</h1>
            <div class="input-group">
                <label for="planetName" data-lang-key="planetNameLabel">Planet Name</label>
                <input type="text" id="planetName" value="B">
            </div>
            <div class="input-group">
                <label for="semiMajorAxisInput" data-lang-key="semiMajorAxisLabel">Semi-major Axis (AU)</label>
                <input type="number" id="semiMajorAxisInput" step="0.1" min="0.01" placeholder="Leave empty for random" data-lang-placeholder-key="semiMajorAxisPlaceholder">
            </div>
            <div class="button-group">
                <button id="generatePlanetBtn" class="btn-primary" data-lang-key="addPlanetBtn">Add Planet</button>
                <button id="clearPlanetsBtn" class="btn-danger" data-lang-key="clearPlanetsBtn">Clear Planets</button>
            </div>
            <div class="planet-preview">
                <h2 data-lang-key="orbitPreviewTitle">Orbit Preview</h2>
                <canvas id="orbitCanvas"></canvas>
            </div>
            <div id="savedPlanetsContainer">
                 <h2 data-lang-key="savedPlanetsTitle">Saved Planets</h2>
                 <div id="planetsList"></div>
            </div>
        </div>
    </div>

<script type="module">
    // Import THREE and OrbitControls from modules defined in the importmap
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const translations = {
        en: {
            starGeneratorTitle: "Star Generator",
            generateStarBtn: "Generate New Star",
            copyStarBtn: "Copy Star Code",
            planetGeneratorTitle: "Planet Generator",
            planetNameLabel: "Planet Name",
            semiMajorAxisLabel: "Semi-major Axis (AU)",
            semiMajorAxisPlaceholder: "Leave empty for random",
            addPlanetBtn: "Add Planet",
            clearPlanetsBtn: "Clear Planets",
            copyPlanetBtn: "Copy Planet Code",
            orbitPreviewTitle: "3D Orbit Preview",
            savedPlanetsTitle: "Saved Planets",
            copyBtn: "Copy",
            removeBtn: "Remove",
            starDescName: "This is a star named",
            starDescType: "It is",
            starDescProps: "Its physical properties are",
            starDescMass: "Mass",
            starDescMassUnit: "times solar mass",
            starDescTemp: "Surface Temperature",
            starDescRadius: "Radius",
            starDescApprox: "approx.",
            starDescRadiusUnit: "thousand km",
            starDescLuminosity: "The star is",
            starDescBrighter: "brighter",
            starDescDimmer: "dimmer",
            starDescAbsMag: "than the Sun, with an absolute magnitude of",
            starDescDistance: ". It is located at a distance of",
            starDescDistanceUnit: "light-years from us.",
            starTypeO: "a massive and extremely hot blue star",
            starTypeB: "a very hot and bright blue-white star",
            starTypeA: "a hot and luminous white star",
            starTypeF: "a yellow-white star, slightly larger and hotter than the Sun",
            starTypeG: "a yellow dwarf star, very similar to our Sun",
            starTypeK: "a cool and dim orange-red dwarf star",
            starTypeM: "a cool and very dim red dwarf star",
            copied: "Copied!",
        },
        zh: {
            starGeneratorTitle: "ææçæå¨",
            generateStarBtn: "çææ°ææ",
            copyStarBtn: "å¤å¶ææä»£ç ",
            planetGeneratorTitle: "è¡æçæå¨",
            planetNameLabel: "è¡æåç§°",
            semiMajorAxisLabel: "åé¿è½´ (å¤©æåä½)",
            semiMajorAxisPlaceholder: "çç©ºåéæºçæ",
            addPlanetBtn: "æ·»å è¡æ",
            clearPlanetsBtn: "æ¸ç©ºè¡æ",
            copyPlanetBtn: "å¤å¶è¡æä»£ç ",
            orbitPreviewTitle: "3Dè½¨éé¢è§",
            savedPlanetsTitle: "å·²ä¿å­è¡æ",
            copyBtn: "å¤å¶",
            removeBtn: "ç§»é¤",
            starDescName: "è¿æ¯ä¸é¢åä¸º",
            starDescType: "å®æ¯ä¸é¢",
            starDescProps: "å¶ç©çå±æ§ä¸º",
            starDescMass: "è´¨é",
            starDescMassUnit: "åå¤ªé³è´¨é",
            starDescTemp: "è¡¨é¢æ¸©åº¦",
            starDescRadius: "åå¾",
            starDescApprox: "çº¦",
            starDescRadiusUnit: "åå¬é",
            starDescLuminosity: "è¯¥ææçååº¦",
            starDescBrighter: "æ¯å¤ªé³æ´äº®",
            starDescDimmer: "æ¯å¤ªé³æ´æ",
            starDescAbsMag: "ï¼å¶ç»å¯¹æç­ä¸º",
            starDescDistance: "ãå®ä½äºè·ç¦»æä»¬",
            starDescDistanceUnit: "åå¹´çå®å®æ·±å¤ã",
            starTypeO: "ä¸é¢å·¨å¤§ä¸æç­çèè²ææ",
            starTypeB: "ä¸é¢éå¸¸æäº®çèç½è²ææ",
            starTypeA: "ä¸é¢ç½ç­æäº®çç½è²ææ",
            starTypeF: "ä¸é¢æ¯å¤ªé³ç¨å¤§ä¸æ´ç­çé»ç½è²ææ",
            starTypeG: "ä¸é¢ä¸æä»¬çå¤ªé³éå¸¸ç¸ä¼¼çé»ç®æ",
            starTypeK: "ä¸é¢ä½æ¸©ä¸ææ·¡çæ©çº¢è²ç®æ",
            starTypeM: "ä¸é¢ä½æ¸©ä¸éå¸¸ææ·¡ççº¢ç®æ",
            copied: "å·²å¤å¶ï¼",
        }
    };

    let currentLang = 'en';
    let lastStarData = {};
    let savedPlanets = [];
    
    // --- 3D Preview Globals ---
    let scene, camera, renderer, controls, systemGroup;

    function setLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if (translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });
        document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => {
            const key = el.dataset.langPlaceholderKey;
            if (translations[lang] && translations[lang][key]) {
                el.placeholder = translations[lang][key];
            }
        });
        if (lastStarData.mass) {
            document.getElementById('starDescription').innerHTML = generateStarDescription(lastStarData);
        }
        renderSavedPlanets();
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        document.getElementById('lang-zh').classList.toggle('active', lang === 'zh');
    }

    function t(key) {
        return translations[currentLang][key];
    }

    // --- STAR GENERATOR ---
    function generateStarData() {
        const solar_mass = 1.0;
        const solar_radius = 1.0;
        const solar_temp = 5778;
        const solar_abs_mag = 4.83;

        const spectral_data = {
            "O": [[16, 100], [30000, 50000]], "B": [[2.1, 16], [10000, 30000]],
            "A": [[1.4, 2.1], [7500, 10000]], "F": [[1.04, 1.4], [6000, 7500]],
            "G": [[0.8, 1.04], [5200, 6000]], "K": [[0.45, 0.8], [3700, 5200]],
            "M": [[0.08, 0.45], [2400, 3700]],
        };

        const spectral_type = Object.keys(spectral_data)[Math.floor(Math.random() * Object.keys(spectral_data).length)];
        const [mass_range, temp_range] = spectral_data[spectral_type];
        
        const mass = parseFloat((Math.random() * (mass_range[1] - mass_range[0]) + mass_range[0]).toFixed(3));
        const temperature = Math.floor(Math.random() * (temp_range[1] - temp_range[0]) + temp_range[0]);
        
        const radius_solar_units = Math.pow(mass, 0.75);
        const radius_km = radius_solar_units * solar_radius * 695700;
        const luminosity = Math.pow(radius_solar_units, 2) * Math.pow(temperature / solar_temp, 4);
        const abs_mag = parseFloat((solar_abs_mag - 2.5 * Math.log10(luminosity)).toFixed(3));
        
        const ra = parseFloat((Math.random() * 360).toFixed(6));
        const dec = parseFloat((Math.random() * 90 * (Math.random() > 0.5 ? 1 : -1)).toFixed(6));
        const distance = parseFloat((Math.random() * 9990 + 10).toFixed(4));
        
        const star_name = `DSS-${Math.floor(Math.random() * 9000) + 1000}`;

        lastStarData = { star_name, mass, temperature, radius_km, abs_mag, ra, dec, distance, spectral_type };
        return lastStarData;
    }

    function generateStarDescription(data) {
        const spectral_data_desc = {
            "O": t("starTypeO"), "B": t("starTypeB"), "A": t("starTypeA"), "F": t("starTypeF"),
            "G": t("starTypeG"), "K": t("starTypeK"), "M": t("starTypeM")
        };
        const description_text = spectral_data_desc[data.spectral_type];
        return `<p>${t("starDescName")} "${data.star_name}". ${t("starDescType")} ${description_text}.</p><p><b>${t("starDescProps")}:</b><br>- ${t("starDescMass")}: ${data.mass.toFixed(2)} ${t("starDescMassUnit")}<br>- ${t("starDescTemp")}: ${data.temperature}K<br>- ${t("starDescRadius")}: ${t("starDescApprox")} ${(data.radius_km / 1000).toFixed(2)} ${t("starDescRadiusUnit")}</p><p>${t("starDescLuminosity")} ${data.abs_mag < 4.83 ? t("starDescBrighter") : t("starDescDimmer")} ${t("starDescAbsMag")} ${data.abs_mag}${t("starDescDistance")} ${data.distance} ${t("starDescDistanceUnit")}</p>`;
    }

    function formatStarCode(data) {
        return `"${data.star_name}"\n{\n    RA ${data.ra.toFixed(6)}\n    Dec ${data.dec.toFixed(6)}\n    Distance ${data.distance.toFixed(4)}\n    AbsMag ${data.abs_mag.toFixed(3)}\n    SpectralType "${data.spectral_type}"\n    Radius ${Math.round(data.radius_km)}\n    Mass ${data.mass.toFixed(3)}\n    Temperature ${data.temperature}\n}`;
    }

    // --- PLANET GENERATOR ---
    function generatePlanetData(star_name, star_mass) {
        const radius = Math.floor(Math.random() * (70000 - 6000) + 6000);
        const semiMajorAxisInput = document.getElementById('semiMajorAxisInput');
        const customSemiMajorAxis = parseFloat(semiMajorAxisInput.value);
        const semi_major_axis = !isNaN(customSemiMajorAxis) && customSemiMajorAxis > 0.0 ? customSemiMajorAxis : parseFloat((Math.random() * (15.0 - 0.1) + 0.1).toFixed(4));
        const orbital_period = parseFloat(Math.sqrt(Math.pow(semi_major_axis, 3) / star_mass).toFixed(4));
        const eccentricity = parseFloat((Math.random()**2 * 0.4 + 0.001).toFixed(4));
        const planetDataObject = {
            planet_name: document.getElementById('planetName').value || "B", star_name, radius, orbital_period, semi_major_axis, eccentricity,
            inclination_orbit: parseFloat((Math.random()**3 * 180).toFixed(4)),
            ascending_node_orbit: parseFloat((Math.random() * 360).toFixed(4)),
            arg_of_pericenter: parseFloat((Math.random() * 360).toFixed(4)),
            mean_anomaly: parseFloat((Math.random() * 360).toFixed(4)),
        };
        return planetDataObject;
    }

    function formatPlanetCode(data) {
        return `"${data.planet_name}" "${data.star_name}"\n{\n    Radius          ${data.radius}\n    EllipticalOrbit\n    {\n        Period          ${data.orbital_period.toFixed(4)}\n        SemiMajorAxis   ${data.semi_major_axis.toFixed(4)}\n        Eccentricity    ${data.eccentricity.toFixed(4)}\n        Inclination     ${data.inclination_orbit.toFixed(4)}\n        AscendingNode   ${data.ascending_node_orbit.toFixed(4)}\n        ArgOfPericenter ${data.arg_of_pericenter.toFixed(4)}\n        MeanAnomaly     ${data.mean_anomaly.toFixed(4)}\n    }\n}`;
    }
    
    // --- UI RENDERING ---
    function renderSavedPlanets() {
        const container = document.getElementById('planetsList');
        container.innerHTML = '';
        savedPlanets.forEach((planet, index) => {
            const entry = document.createElement('div');
            entry.className = 'planet-entry';
            entry.innerHTML = `<h3>${planet.star_name} ${planet.planet_name}</h3><div class="planet-code">${formatPlanetCode(planet)}</div><div class="planet-actions"><button class="btn-secondary copy-planet" data-index="${index}">${t('copyBtn')}</button><button class="btn-danger remove-planet" data-index="${index}">${t('removeBtn')}</button></div>`;
            container.appendChild(entry);
        });
    }

    function getStarColor(type) {
        const colors = { "O": "#9bb0ff", "B": "#aabfff", "A": "#cad7ff", "F": "#f8f7ff", "G": "#fff4ea", "K": "#ffd2a1", "M": "#ffcc6f" };
        return colors[type] || "#ffffff";
    }
    
    // --- 3D ORBIT PREVIEW ---
    function init3DPreview() {
        const canvas = document.getElementById('orbitCanvas');
        scene = new THREE.Scene();
        
        camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera.position.set(10, 10, 10);
        
        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
        renderer.setPixelRatio(window.devicePixelRatio);
        
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        systemGroup = new THREE.Group();
        scene.add(systemGroup);

        window.addEventListener('resize', onWindowResize, false);

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    }
    
    function onWindowResize() {
        const canvas = document.getElementById('orbitCanvas');
        if (!canvas) return;
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height, false);
    }

    function update3DPreview(planets, starData) {
        // Clear previous system
        while(systemGroup.children.length > 0){ 
            systemGroup.remove(systemGroup.children[0]); 
        }

        if (!starData.mass) return;
        
        let maxApoapsis = 0;
        planets.forEach(p => {
            const apoapsis = p.semi_major_axis * (1 + p.eccentricity);
            if (apoapsis > maxApoapsis) maxApoapsis = apoapsis;
        });
        const scale = maxApoapsis > 0 ? 20 / maxApoapsis : 20;

        // Draw Star
        const starRadius = Math.max(0.5, Math.pow(starData.mass, 0.5) * 0.5) * (scale / 20); // Scale star size reasonably
        const starGeometry = new THREE.SphereGeometry(starRadius, 32, 32);
        const starColor = getStarColor(starData.spectral_type);
        const starMaterial = new THREE.MeshBasicMaterial({ color: starColor });
        const star = new THREE.Mesh(starGeometry, starMaterial);
        systemGroup.add(star);
        
        const starLight = new THREE.PointLight(starColor, 1.5, 1000);
        systemGroup.add(starLight);

        // Reference plane (ecliptic)
        const gridHelper = new THREE.GridHelper(maxApoapsis * scale * 2.2, 20);
        gridHelper.rotation.x = Math.PI / 2;
        systemGroup.add(gridHelper);

        // Draw Orbits and Planets
        const orbitColors = [0x00aaff, 0xff6347, 0x32cd32, 0xffd700, 0xba55d3, 0xff4500];

        planets.forEach((planet, index) => {
            const a = planet.semi_major_axis * scale;
            const e = planet.eccentricity;
            const c = e * a; // distance from center to focus
            const b = Math.sqrt(a*a - c*c); // semi-minor axis

            const curve = new THREE.EllipseCurve( -c, 0, a, b, 0, 2 * Math.PI, false, 0 );
            const points = curve.getPoints(128);
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ color: orbitColors[index % orbitColors.length] });
            const ellipse = new THREE.Line(geometry, material);
            
            const orbitGroup = new THREE.Group();
            orbitGroup.add(ellipse);

            // Correctly apply orbital elements using matrix transformations.
            // The correct order to transform from the orbital plane to the ecliptic plane
            // is to first apply the Argument of Pericenter (w), then the Inclination (i),
            // and finally the Longitude of the Ascending Node (o).
            const i = THREE.MathUtils.degToRad(planet.inclination_orbit);
            const w = THREE.MathUtils.degToRad(planet.arg_of_pericenter);
            const o = THREE.MathUtils.degToRad(planet.ascending_node_orbit);
            
            // Create rotation matrices for each element
            const rot_w = new THREE.Matrix4().makeRotationZ(w); // 1. Argument of Pericenter
            const rot_i = new THREE.Matrix4().makeRotationX(i); // 2. Inclination
            const rot_o = new THREE.Matrix4().makeRotationZ(o); // 3. Longitude of Ascending Node

            // Combine the matrices. Matrix multiplication order is read right-to-left.
            // O * I * W means we apply W, then I, then O.
            const rotationMatrix = new THREE.Matrix4();
            rotationMatrix.multiply(rot_o);
            rotationMatrix.multiply(rot_i);
            rotationMatrix.multiply(rot_w);

            // Apply the final rotation matrix to the orbit group
            orbitGroup.setRotationFromMatrix(rotationMatrix);

            systemGroup.add(orbitGroup);

            // Position planet on its orbit
            // This is a simplified positioning using mean anomaly directly
            // A full implementation requires solving Kepler's equation
            const meanAnomalyRad = THREE.MathUtils.degToRad(planet.mean_anomaly);
            const planetPos = curve.getPoint(meanAnomalyRad / (2 * Math.PI));

            const planetRadius = Math.max(0.2, (planet.radius / 6371) * 0.2) * (scale / 20); // Earth radius = 6371km
            const planetGeom = new THREE.SphereGeometry(planetRadius, 16, 16);
            const planetMat = new THREE.MeshStandardMaterial({ 
                color: orbitColors[index % orbitColors.length], 
                roughness: 0.8 
            });
            const planetMesh = new THREE.Mesh(planetGeom, planetMat);
            planetMesh.position.set(planetPos.x, planetPos.y, 0);

            // Add the planet mesh to the rotated orbit group
            orbitGroup.add(planetMesh);
        });
        
        // Update camera position to fit the system
        camera.position.set(maxApoapsis * scale * 0.8, maxApoapsis * scale * 0.8, maxApoapsis * scale * 0.8);
        controls.target.set(0, 0, 0);
        controls.update();
    }


    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        const starOutput = document.getElementById('starOutput');
        const starDesc = document.getElementById('starDescription');

        init3DPreview(); // Initialize the 3D scene

        document.getElementById('generateStarBtn').addEventListener('click', () => {
            const data = generateStarData();
            starOutput.textContent = formatStarCode(data);
            starDesc.innerHTML = generateStarDescription(data);
            
            savedPlanets = [];
            renderSavedPlanets();
            update3DPreview(savedPlanets, lastStarData);
            document.getElementById('planetName').value = "B";
            document.getElementById('semiMajorAxisInput').value = "";
        });

        document.getElementById('copyStarBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(starOutput.textContent.trim()).then(() => alert(t('copied')));
        });

        document.getElementById('generatePlanetBtn').addEventListener('click', () => {
            if (!lastStarData.mass) {
                alert(currentLang === 'zh' ? 'è¯·åçæä¸é¢ææï¼' : 'Please generate a star first!');
                return;
            }
            const data = generatePlanetData(lastStarData.star_name, lastStarData.mass);
            savedPlanets.push(data);
            renderSavedPlanets();
            update3DPreview(savedPlanets, lastStarData);
            
            const currentName = document.getElementById('planetName').value;
            document.getElementById('planetName').value = String.fromCharCode(currentName.charCodeAt(0) + 1);
        });
        
        document.getElementById('clearPlanetsBtn').addEventListener('click', () => {
            savedPlanets = [];
            renderSavedPlanets();
            update3DPreview(savedPlanets, lastStarData);
            document.getElementById('planetName').value = "B";
            document.getElementById('semiMajorAxisInput').value = "";
        });

        document.getElementById('planetsList').addEventListener('click', (e) => {
            const target = e.target;
            const index = target.dataset.index;
            if (index === undefined) return;

            if (target.classList.contains('copy-planet')) {
                const planetCode = formatPlanetCode(savedPlanets[index]);
                navigator.clipboard.writeText(planetCode.trim()).then(() => alert(t('copied')));
            } else if (target.classList.contains('remove-planet')) {
                savedPlanets.splice(index, 1);
                renderSavedPlanets();
                update3DPreview(savedPlanets, lastStarData);
            }
        });

        document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
        document.getElementById('lang-zh').addEventListener('click', () => setLanguage('zh'));

        setLanguage('en');
        document.getElementById('generateStarBtn').click();
        onWindowResize(); // Ensure initial size is correct
    });
</script>
</body>
</html>

